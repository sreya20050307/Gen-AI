{% extends 'base.html' %}

{% block title %}Model Metrics - Email Classifier{% endblock %}

{% block extra_css %}
<style>
    .metric-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border: none;
        border-radius: 0.5rem;
        overflow: hidden;
    }
    
    .metric-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1) !important;
    }
    
    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        line-height: 1;
    }
    
    .metric-label {
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: #6b7280;
    }
    
    .metric-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        margin-bottom: 1rem;
    }
    
    .confusion-matrix {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }
    
    .confusion-matrix th, 
    .confusion-matrix td {
        text-align: center;
        padding: 0.75rem;
        border: 1px solid #e5e7eb;
    }
    
    .confusion-matrix th {
        background-color: #f9fafb;
        font-weight: 600;
        color: #4b5563;
    }
    
    .confusion-matrix .row-header {
        background-color: #f9fafb;
        font-weight: 600;
        color: #4b5563;
        white-space: nowrap;
    }
    
    .confusion-matrix .diagonal {
        background-color: rgba(16, 185, 129, 0.1);
    }
    
    .confusion-matrix .off-diagonal {
        background-color: rgba(239, 68, 68, 0.05);
    }
    
    .metrics-report {
        background-color: #f9fafb;
        border-radius: 0.5rem;
        padding: 1.25rem;
        font-family: 'Courier New', Courier, monospace;
        font-size: 0.875rem;
        white-space: pre-wrap;
        overflow-x: auto;
    }
    
    .badge-important {
        background-color: #eef2ff;
        color: #4f46e5;
    }
    
    .badge-promotion {
        background-color: #ecfdf5;
        color: #10b981;
    }
    
    .badge-spam {
        background-color: #fef2f2;
        color: #ef4444;
    }
    
    .progress-thin {
        height: 6px;
    }
    
    .category-score {
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-9">
    <div class="page-header d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="page-title mb-1">Model performance</h2>
        <p class="text-muted small mb-0">Understand how the classifier behaves across your email categories.</p>
      </div>
      <span class="badge rounded-pill bg-soft-secondary text-secondary d-none d-md-inline-flex align-items-center">
        <i class="fa-solid fa-robot me-1"></i>Offline evaluation from <code>train_model.py</code>
      </span>
    </div>

    {% if not metrics %}
      <div class="card glass-card shadow-soft">
        <div class="card-body d-flex align-items-center">
          <div class="me-3 text-warning display-6">
            <i class="fa-solid fa-triangle-exclamation"></i>
          </div>
          <div>
            <h5 class="mb-1">No metrics available yet</h5>
            <p class="text-muted small mb-0">
              Run <code>python train_model.py</code> to train the model and generate accuracy, confusion matrix,
              and a full classification report.
            </p>
          </div>
        </div>
      </div>
    {% else %}
      {% if email_analysis %}
      <div class="card glass-card shadow-soft mb-4">
        <div class="card-body">
          <h5 class="mb-3">
            <i class="fas fa-envelope-open-text me-2 text-primary"></i>
            Email Analysis
          </h5>
          <div class="row">
            <div class="col-md-6">
              <p class="small text-muted mb-1">Predicted Category</p>
              <span class="badge prediction-badge prediction-{{ email_analysis.prediction|lower }} mb-3">
                <i class="fas fa-tag me-1"></i>{{ email_analysis.prediction|capitalize }}
              </span>
              <p class="small text-muted mb-1">Confidence Score</p>
              <div class="d-flex align-items-center mb-3">
                <div class="progress flex-grow-1 me-2" style="height: 6px;">
                  <div class="progress-bar" role="progressbar" 
                       style="width: {{ '%.0f'|format(email_analysis.confidence * 100) }}%"
                       aria-valuenow="{{ '%.0f'|format(email_analysis.confidence * 100) }}" 
                       aria-valuemin="0" 
                       aria-valuemax="100"></div>
                </div>
                <span class="small fw-semibold">{{ '%.1f'|format(email_analysis.confidence * 100) }}%</span>
              </div>
            </div>
            <div class="col-md-6">
              <p class="small text-muted mb-1">Email Preview</p>
              <div class="bg-light p-2 small rounded" style="max-height: 120px; overflow: auto;">
                {{ email_analysis.text[:200] }}{% if email_analysis.text|length > 200 %}...{% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

      <div class="row g-4">
        <div class="col-md-4">
          <div class="card glass-card h-100 shadow-soft">
            <div class="card-body">
              <p class="text-muted small mb-1">Overall accuracy</p>
              <p class="display-5 fw-semibold mb-1">{{ '%.2f'|format(metrics.accuracy * 100) }}<span class="fs-5">%</span></p>
              <p class="text-muted small mb-0">on the held-out evaluation set.</p>
            </div>
          </div>
        </div>
        <div class="col-md-8">
          <div class="card glass-card h-100 shadow-soft">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Confusion matrix</h6>
                <span class="badge bg-soft-primary text-primary small">True vs. predicted classes</span>
              </div>
              <div class="table-responsive-sm metrics-table-wrapper">
                <table class="table table-sm table-bordered mb-0">
                  <thead class="table-light small">
                    <tr>
                      <th scope="col">True \ Pred</th>
                      {% for label in metrics.labels %}
                      <th scope="col">{{ label|capitalize }}</th>
                      {% endfor %}
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in metrics.confusion_matrix %}
                    <tr>
                      <th scope="row" class="small">{{ metrics.labels[loop.index0]|capitalize }}</th>
                      {% for value in row %}
                      <td class="small">{{ value }}</td>
                      {% endfor %}
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="card glass-card shadow-soft mt-4">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0">Detailed classification report</h6>
            <span class="badge bg-soft-info text-info small"><i class="fa-solid fa-table-list me-1"></i>Precision, recall, F1-score</span>
          </div>
          <pre class="metrics-report mb-0">{{ metrics.classification_report }}</pre>
        </div>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}
